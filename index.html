<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#10b981"/>
  <link rel="manifest" href="./manifest.webmanifest"/>
  <link rel="icon" href="./assets/icon-192.png"/>
  <link rel="apple-touch-icon" href="./assets/icon-192.png"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="QuitCounter">
  <title>QuitCounter — 9/día con hucha semanal</title>
  <link rel="stylesheet" href="./styles.css"/>
</head>
<body>
  <div class="app">
    <div class="card row">
      <div>
        <h1>QuitCounter</h1>
        <small>9/día → los no fumados pasan a la hucha semanal. Lunes 00:00 se reinicia la hucha.</small>
        <div id="diag" class="err">Cargando JS…</div>
      </div>
      <div class="row" style="justify-content:end;gap:8px">
        <button id="install" class="btn install" style="display:none" type="button">Instalar</button>
      </div>
    </div>

    <div class="card">
      <div class="row" style="align-items:center">
        <div class="center">
          <div>
            <div>Consumidos hoy</div>
            <div id="count" class="big">0</div>
          </div>
        </div>
        <div class="center">
          <div>
            <div>Restantes hoy</div>
            <div id="remaining" class="big">9</div>
          </div>
        </div>
      </div>
      <div style="margin-top:10px">
        <progress id="bar" value="0" max="100"></progress>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="minus" class="btn ghost" type="button">−1</button>
        <button id="plus" class="btn" type="button">+1</button>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="closeDay" class="btn ghost" type="button">Cerrar día ahora</button>
        <button id="resetWeek" class="btn ghost" type="button">Vaciar hucha (forzar)</button>
      </div>
    </div>

    <div class="card">
      <div class="row" style="align-items:center">
        <div>
          <label>Cuota diaria</label>
          <input id="quotaInput" type="number" min="1" max="99" value="9"/>
        </div>
        <div style="align-self:end;display:flex;justify-content:flex-end">
          <button id="saveCfg" class="btn" type="button">Guardar</button>
        </div>
      </div>
      <small>Nota: la hucha se resetea automáticamente cuando cambia la semana (lunes 00:00). El traspaso diario se hace al llegar las 00:00 o al pulsar “Cerrar día ahora”.</small>
    </div>

    <footer>Funciona offline e instalable (PWA). Sube esta carpeta a GitHub Pages.</footer>
  </div>
  <script>
'use strict';
const CONFIG_KEY='qc_cfg',STATE_KEY='qc_state';const cfgDefault={dailyQuota:9};const $=s=>document.querySelector(s),pad=n=>String(n).padStart(2,'0');
function todayLocalDateStr(d=new Date()){const y=d.getFullYear();const m=pad(d.getMonth()+1);const day=pad(d.getDate());return `${y}-${m}-${day}`;}
function isoWeekId(date){const copy=new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate()));const dayNum=(copy.getUTCDay()+6)%7;copy.setUTCDate(copy.getUTCDate()-dayNum+3);const firstThursday=new Date(Date.UTC(copy.getUTCFullYear(),0,4));const week=1+Math.round(((copy-firstThursday)/86400000-3+((firstThursday.getUTCDay()+6)%7))/7);const weekYear=copy.getUTCFullYear();return `${weekYear}-W${String(week).padStart(2,'0')}`;}
function loadCfg(){try{return JSON.parse(localStorage.getItem(CONFIG_KEY))||cfgDefault;}catch(e){return cfgDefault;}}function saveCfg(c){localStorage.setItem(CONFIG_KEY,JSON.stringify(c));}
function loadState(){try{return JSON.parse(localStorage.getItem(STATE_KEY))||null;}catch(e){return null;}}function saveState(s){localStorage.setItem(STATE_KEY,JSON.stringify(s));}
function initState(){const now=new Date();return {lastDate:todayLocalDateStr(now),todayCount:0,weekBank:0,weekId:isoWeekId(now)};}
function rolloverIfNeeded(){const cfg=loadCfg();let st=loadState()||initState();const now=new Date();const todayStr=todayLocalDateStr(now);if(st.lastDate===todayStr)return st;let cursor=new Date(st.lastDate+'T00:00:00');const end=new Date(todayStr+'T00:00:00');while(cursor<end){const isFirstDay=(todayLocalDateStr(cursor)===st.lastDate);const consumed=isFirstDay?st.todayCount:0;const leftover=Math.max(0,cfg.dailyQuota-consumed);st.weekBank+=leftover;const next=new Date(cursor);next.setDate(cursor.getDate()+1);if(next.getDay()===1){st.weekBank=0;st.weekId=isoWeekId(next);}cursor=next;}st.todayCount=0;st.lastDate=todayLocalDateStr(new Date());saveState(st);return st;}
function updateUI(){const cfg=loadCfg();const st=rolloverIfNeeded();const q=$('#quota'),c=$('#count'),r=$('#remaining'),b=$('#bank');if(!q||!c||!r||!b)return;q.textContent=cfg.dailyQuota;c.textContent=st.todayCount;r.textContent=Math.max(0,cfg.dailyQuota-st.todayCount);b.textContent=st.weekBank;const p=Math.min(1,st.todayCount/cfg.dailyQuota);const bar=$('#bar');if(bar){bar.value=Math.round(p*100);bar.max=100;}renderTimers();const diag=$('#diag');if(diag){diag.textContent='JS cargado ✓';diag.className='ok';}}
function addOne(){const cfg=loadCfg();const st=rolloverIfNeeded();if(st.todayCount>=cfg.dailyQuota){shake('#count');return;}st.todayCount+=1;saveState(st);updateUI();}
function removeOne(){const st=rolloverIfNeeded();if(st.todayCount<=0)return;st.todayCount-=1;saveState(st);updateUI();}
function closeDayNow(){let st=loadState()||initState();const cfg=loadCfg();const leftover=Math.max(0,cfg.dailyQuota-st.todayCount);st.weekBank+=leftover;st.todayCount=0;st.lastDate=todayLocalDateStr(new Date());saveState(st);updateUI();}
function resetWeek(){let st=loadState()||initState();st.weekBank=0;st.weekId=isoWeekId(new Date());saveState(st);updateUI();}
function saveSettings(){const el=$('#quotaInput');const v=Number(el&&el.value?el.value:9);const cfg=loadCfg();cfg.dailyQuota=Math.max(1,Math.min(99,v));saveCfg(cfg);updateUI();}
let timerInterval=null;function pad2(n){return String(n).padStart(2,'0');}
function msToHMS(ms){const total=Math.max(0,Math.floor(ms/1000));const h=Math.floor(total/3600);const m=Math.floor((total%3600)/60);const s=total%60;return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;}
function nextMidnight(){const n=new Date();const t=new Date(n);t.setHours(24,0,0,0);return t;}
function nextMonday00(){const n=new Date();const day=n.getDay();const add=(8-(day===0?7:day))%7;const d=new Date(n);d.setDate(n.getDate()+add);d.setHours(0,0,0,0);return d;}
function renderTimers(){if(timerInterval)clearInterval(timerInterval);function tick(){const msDay=nextMidnight()-new Date();const dayT=$('#dayTimer');if(dayT)dayT.textContent=msToHMS(msDay);const msWeek=nextMonday00()-new Date();const weekT=$('#weekTimer');if(weekT)weekT.textContent=msToHMS(msWeek);const st=loadState();const todayStr=todayLocalDateStr(new Date());if(st&&st.lastDate!==todayStr){rolloverIfNeeded();updateUI();}}tick();timerInterval=setInterval(tick,1000);}
function shake(sel){const el=$(sel);if(!el)return;el.style.transform='scale(1.05)';setTimeout(()=>{el.style.transform='scale(1)';},120);}
let deferredPrompt=null;window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;const b=$('#install');if(b)b.style.display='inline-flex';});
async function doInstall(){if(!deferredPrompt)return;deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;const b=$('#install');if(b)b.style.display='none';}
window.addEventListener('load',()=>{if('serviceWorker'in navigator){navigator.serviceWorker.register('./sw.js');}});
window.addEventListener('DOMContentLoaded',()=>{[['#plus',addOne],['#minus',removeOne],['#closeDay',closeDayNow],['#resetWeek',resetWeek],['#saveCfg',saveSettings],['#install',doInstall]].forEach(([sel,fn])=>{const el=$(sel);if(el)el.addEventListener('click',fn);});const qi=$('#quotaInput');if(qi)qi.value=loadCfg().dailyQuota;updateUI();});

  </script>
</body>
</html>
